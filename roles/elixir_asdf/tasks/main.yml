---
- name: Get the current user info
  shell: echo $HOME
  register: user_home
  changed_when: false
  become: no

- name: Set asdf variables
  set_fact:
    asdf_home: "{{ user_home.stdout }}"

- name: Install required system dependencies
  apt:
    name:
      - git
      - curl
      - build-essential
      - autoconf
      - libssl-dev
      - libncurses5-dev
      - m4
      - unzip
    state: present
    update_cache: yes
  become: yes

- name: Check if asdf is already installed
  stat:
    path: "{{ asdf_home }}/.asdf"
  become: no
  register: asdf_dir

- name: Get latest asdf version
  uri:
    url: https://api.github.com/repos/asdf-vm/asdf/releases/latest
    return_content: yes
  register: asdf_latest
  when: not asdf_dir.stat.exists

- name: Set latest asdf version
  set_fact:
    asdf_latest_version: "{{ asdf_latest.json.tag_name }}"
  when: "'json' in asdf_latest and asdf_latest.json is defined"

- name: Download asdf release archive
  get_url:
    url: "https://github.com/asdf-vm/asdf/releases/download/{{ asdf_latest_version }}/asdf-{{ asdf_latest_version }}-linux-amd64.tar.gz"
    dest: "/tmp/asdf-{{ asdf_latest_version }}.tar.gz"
    mode: '0644'
  become: no
  when: not asdf_dir.stat.exists

- name: Create asdf directory
  file:
    path: "{{ asdf_home }}/.asdf/bin"
    state: directory
    mode: '0755'
  become: no
  when: not asdf_dir.stat.exists

- name: Extract asdf archive
  command: tar -xzf /tmp/asdf-{{ asdf_latest_version }}.tar.gz -C {{ asdf_home }}/.asdf/bin
  become: no
  when: not asdf_dir.stat.exists

- name: Clean up downloaded archive
  file:
    path: "/tmp/asdf-{{ asdf_latest_version }}.tar.gz"
    state: absent
  become: no
  when: not asdf_dir.stat.exists

- name: Add asdf to bashrc
  blockinfile:
    path: "{{ asdf_home }}/.bashrc"
    block: |
      . <(asdf completion bash)
      export PATH="$HOME/.asdf/shims:$HOME/.asdf/bin:$PATH"
    marker: "# {mark} ANSIBLE MANAGED BLOCK - asdf"
    create: yes
  become: no

- name: Install and configure Erlang and Elixir with asdf
  block:
    - name: Check if Erlang plugin is installed
      shell: asdf plugin list | grep -q erlang
      args:
        executable: /bin/bash
      register: erlang_plugin_check
      changed_when: false
      failed_when: false

    - name: Add Erlang plugin to asdf
      shell: |
        asdf plugin add erlang https://github.com/asdf-vm/asdf-erlang.git
      args:
        executable: /bin/bash
      when: erlang_plugin_check.rc != 0

    - name: Check if Elixir plugin is installed
      shell: |
        asdf plugin list | grep -q elixir
      args:
        executable: /bin/bash
      register: elixir_plugin_check
      changed_when: false
      failed_when: false

    - name: Add Elixir plugin to asdf
      shell: |
        asdf plugin add elixir https://github.com/asdf-vm/asdf-elixir.git
      args:
        executable: /bin/bash
      when: elixir_plugin_check.rc != 0

    - name: Get latest Erlang version
      shell: |
        asdf list all erlang | grep -v -E 'rc|master' | tail -2 | head -1
      args:
        executable: /bin/bash
      register: latest_erlang
      changed_when: false

    - name: Check if latest Erlang version is installed
      shell: |
        asdf list erlang | grep -q "{{ latest_erlang.stdout }}"
      args:
        executable: /bin/bash
      register: erlang_version_check
      changed_when: false
      failed_when: false

    - name: Install latest Erlang
      shell: |
        asdf install erlang {{ latest_erlang.stdout }}
      args:
        executable: /bin/bash
      when: erlang_version_check.rc != 0

    - name: Set global Erlang version
      shell: |
        asdf set --home erlang {{ latest_erlang.stdout }}
      args:
        executable: /bin/bash
      when: erlang_version_check.rc != 0

    - name: Get latest Elixir version
      shell: |
        asdf list all elixir | grep -v -E 'rc|master|otp' | tail -2 | head -1
      args:
        executable: /bin/bash
      register: latest_elixir
      changed_when: false

    - name: Check if latest Elixir version is installed
      shell: |
        asdf list elixir | grep -q "{{ latest_elixir.stdout }}"
      args:
        executable: /bin/bash
      register: elixir_version_check
      changed_when: false
      failed_when: false

    - name: Install latest Elixir
      shell: |
        asdf install elixir {{ latest_elixir.stdout }}
      args:
        executable: /bin/bash
      when: elixir_version_check.rc != 0

    - name: Set global Elixir version
      shell: |
        asdf set --home elixir {{ latest_elixir.stdout }}
      args:
        executable: /bin/bash
      when: elixir_version_check.rc != 0

    - name: Verify Elixir installation
      shell: |
        elixir --version
      args:
        executable: /bin/bash
      register: elixir_verify
      changed_when: false

  environment:
    PATH: "{{ asdf_home }}/.asdf/shims:{{ asdf_home }}/.asdf/bin:{{ ansible_env.PATH }}"
  become: no